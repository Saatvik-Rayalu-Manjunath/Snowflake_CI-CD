name: "ğŸš¨ TEMP Snowflake Demo (HARD-CODED CREDS â€” REMOVE AFTER TEST)"

on:
  workflow_dispatch: {}
  push:
    branches: [ "main", "demo" ]

jobs:
  deploy:
    name: "ğŸ¯ Deploy to Production"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --quiet snowflake-connector-python

      - name: ğŸ§ª Test Connection (HARD-CODED)
        run: |
          python - <<'PY'
          import snowflake.connector
          # ---------- HARD-CODED (TEMP) ----------
          USER      = "saatvikrayalu"                 # <--- REPLACE IF NEEDED
          PASSWORD  = "REPLACE_ME_PASSWORD"           # <--- REPLACE
          ACCOUNT   = "jfuvmro-fb11082.us-west-2"     # <--- REPLACE (no .snowflakecomputing.com)
          WAREHOUSE = "COMPUTE_WH"                    # <--- REPLACE IF NEEDED
          # Mask the password in logs (best-effort)
          print("::add-mask::" + PASSWORD)
          # ---------------------------------------
          conn = snowflake.connector.connect(
              user=USER, password=PASSWORD, account=ACCOUNT, warehouse=WAREHOUSE
          )
          cur = conn.cursor()
          cur.execute("select current_user(), current_account(), current_region(), current_version()")
          print("âœ… Connected:", cur.fetchone())
          cur.close(); conn.close()
          PY

      - name: ğŸš€ Deploy to Production (HARD-CODED)
        run: |
          echo "ğŸ¬ Starting automated deployment..."
          if [ -f migrate.py ]; then
            python migrate.py
          else
            echo "â„¹ï¸ No migrate.py found. Skipping deploy step."
          fi
          echo "ğŸ‰ Deployment completed!"

      - name: ğŸ“Š Post-Deployment Report (HARD-CODED)
        if: always()
        run: |
          python - <<'PY'
          import snowflake.connector
        USER      = "saatvikrayalu"           
          PASSWORD  = "w_vrX7.CVfFNh.8"           
          ACCOUNT   = "JFUVMRO-FB11082"     
          WAREHOUSE = "COMPUTE_WH"
          print("::add-mask::" + PASSWORD)
          try:
            conn = snowflake.connector.connect(
              user=USER, password=PASSWORD, account=ACCOUNT, warehouse=WAREHOUSE
            )
            cur = conn.cursor()
            try:
              cur.execute("select count(*) from PROD_DB.PUBLIC.products")
              count = cur.fetchone()[0]
              print(f"ğŸ“ˆ FINAL STATUS: {count} products now live in PRODUCTION")
            except Exception as e:
              print(f"â„¹ï¸ Report skipped (table missing or privilege issue): {e}")
            finally:
              cur.close(); conn.close()
          except Exception as e:
            print(f"â„¹ï¸ Could not connect for report: {e}")
          PY

